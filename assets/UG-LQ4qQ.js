class n{static instance;roomRegistry=new Map;messageHandlers=[];broadcastChannel=null;constructor(){typeof window<"u"&&"BroadcastChannel"in window&&(this.broadcastChannel=new BroadcastChannel("doudizhu-signaling"),this.broadcastChannel.onmessage=o=>{const e=o.data;this.messageHandlers.forEach(t=>t(e))})}static getInstance(){return n.instance||(n.instance=new n),n.instance}registerRoom(o){this.roomRegistry.set(o.roomCode,o),console.log("ğŸ“¡ æˆ¿é—´å·²æ³¨å†Œ:",o),this.broadcast({type:"room-info",roomCode:o.roomCode,from:o.hostPeerId,data:o,timestamp:Date.now()})}getRoomInfo(o){const e=this.roomRegistry.get(o);return e?(console.log("ğŸ“¡ æ‰¾åˆ°æˆ¿é—´ä¿¡æ¯:",e),e):(console.log(`ğŸ“¡ æˆ¿é—´ä¸å­˜åœ¨: ${o}`),null)}generateRoomLink(o){let e="https://zyhwy5.github.io/doudizhu/";if(typeof window<"u"){const a=window.location.host;!a.includes("localhost")&&!a.includes("127.0.0.1")&&(e=`${window.location.protocol}//${window.location.host}${window.location.pathname}`)}const t=new URLSearchParams({join:o.roomCode,host:o.hostPeerId,name:o.hostName,t:o.timestamp.toString()}),s=`${e}#/room/${o.roomCode}?${t.toString()}`;return console.log("ğŸ“¡ ç”Ÿæˆæˆ¿é—´é“¾æ¥:",s),s}generateQRData(o){return this.generateRoomLink(o)}parseRoomFromUrl(){if(typeof window>"u")return null;try{const o=window.location.hash.match(/\/room\/([A-Z0-9]{6})/);if(!o)return null;const e=o[1],t=new URLSearchParams(window.location.search),s=t.get("host"),a=t.get("name"),r=t.get("t");if(s&&a&&r){const i={roomCode:e,hostPeerId:s,hostName:a,timestamp:parseInt(r)};return console.log("ğŸ“¡ ä»URLè§£ææˆ¿é—´ä¿¡æ¯:",i),{roomCode:e,hostInfo:i}}}catch(o){console.error("ğŸ“¡ è§£æURLæˆ¿é—´ä¿¡æ¯å¤±è´¥:",o)}return null}broadcast(o){this.broadcastChannel&&(this.broadcastChannel.postMessage(o),console.log("ğŸ“¡ å¹¿æ’­æ¶ˆæ¯:",o.type))}onMessage(o){this.messageHandlers.push(o)}offMessage(o){const e=this.messageHandlers.indexOf(o);e>-1&&this.messageHandlers.splice(e,1)}cleanupExpiredRooms(){const o=Date.now(),e=3600*1e3;for(const[t,s]of this.roomRegistry.entries())o-s.timestamp>e&&(this.roomRegistry.delete(t),console.log(`ğŸ“¡ æ¸…ç†è¿‡æœŸæˆ¿é—´: ${t}`))}cleanup(){this.broadcastChannel&&(this.broadcastChannel.close(),this.broadcastChannel=null),this.messageHandlers=[],this.roomRegistry.clear(),console.log("ğŸ“¡ æ¸…ç†ä¿¡ä»¤æœåŠ¡èµ„æº")}}const c=n.getInstance(),h=l=>c.generateRoomLink(l),d=()=>c.parseRoomFromUrl();export{n as SimpleSignalingService,h as generateRoomLink,d as parseRoomFromUrl,c as signalingService};
