import{a2 as q,a7 as x,r as u,k as p,a8 as h}from"#entry";class N{peer=null;connections=new Map;messageHandlers=[];roomCode="";peerId="";isHost=!1;isInitialized=!1;constructor(){}async initialize(e,o,s){this.roomCode=e,this.peerId=o,this.isHost=s;try{const{default:n}=await q(async()=>{const{default:t}=await import("./BxLQoAyG.js");return{default:t}},[],import.meta.url);return this.peer=new n(o,{secure:!0,config:{iceServers:[{urls:"stun:stun.l.google.com:19302"},{urls:"stun:stun1.l.google.com:19302"},{urls:"stun:stun.services.mozilla.com"},{urls:"turn:openrelay.metered.ca:80",username:"openrelayproject",credential:"openrelayproject"}]},debug:2}),new Promise((t,d)=>{this.peer.on("open",i=>{console.log("ðŸŒ PeerJSè¿žæŽ¥æˆåŠŸï¼ŒID:",i),this.isInitialized=!0,this.isHost&&this.setupHostListeners(),t()}),this.peer.on("error",i=>{console.error("ðŸŒ PeerJSè¿žæŽ¥é”™è¯¯:",i),d(i)}),this.peer.on("connection",i=>{console.log("ðŸŒ æ”¶åˆ°æ–°çš„peerè¿žæŽ¥:",i.peer),this.setupConnection(i)}),this.peer.on("disconnected",()=>{console.log("ðŸŒ PeerJSè¿žæŽ¥æ–­å¼€ï¼Œå°è¯•é‡è¿ž"),this.peer.reconnect()})})}catch(n){throw console.error("ðŸŒ PeerJSåˆå§‹åŒ–å¤±è´¥:",n),n}}setupHostListeners(){console.log("ðŸŒ æˆ¿ä¸»æ¨¡å¼ï¼šç­‰å¾…å®¢æˆ·ç«¯è¿žæŽ¥")}setupConnection(e){this.connections.set(e.peer,e),e.on("open",()=>{console.log("ðŸŒ æ•°æ®è¿žæŽ¥å·²å»ºç«‹:",e.peer)}),e.on("data",o=>{try{const s=typeof o=="string"?JSON.parse(o):o;console.log("ðŸŒ æ”¶åˆ°æ•°æ®:",s.type,"from:",e.peer),this.messageHandlers.forEach(n=>n(s,e.peer))}catch(s){console.error("ðŸŒ è§£æžæ¶ˆæ¯å¤±è´¥:",s)}}),e.on("close",()=>{console.log("ðŸŒ è¿žæŽ¥å…³é—­:",e.peer),this.connections.delete(e.peer)}),e.on("error",o=>{console.error("ðŸŒ è¿žæŽ¥é”™è¯¯:",o),this.connections.delete(e.peer)})}async connectToPeer(e){if(!this.isInitialized)throw new Error("PeerJS not initialized");try{console.log("ðŸŒ è¿žæŽ¥åˆ°peer:",e);const o=this.peer.connect(e,{reliable:!0,serialization:"json"});return new Promise((s,n)=>{o.on("open",()=>{console.log("ðŸŒ æˆåŠŸè¿žæŽ¥åˆ°peer:",e),this.setupConnection(o),s()}),o.on("error",t=>{console.error("ðŸŒ è¿žæŽ¥peerå¤±è´¥:",t),n(t)}),setTimeout(()=>{o.open||n(new Error("è¿žæŽ¥è¶…æ—¶"))},1e4)})}catch(o){throw console.error("ðŸŒ è¿žæŽ¥peerå¼‚å¸¸:",o),o}}async sendMessage(e){if(!this.isInitialized)throw new Error("PeerJS not initialized");const o={...e,timestamp:Date.now(),senderId:this.peerId};JSON.stringify(o);let s=0;for(const[n,t]of this.connections.entries())if(t.open)try{t.send(o),s++,console.log("ðŸŒ æ¶ˆæ¯å‘é€åˆ°:",n)}catch(d){console.error("ðŸŒ å‘é€æ¶ˆæ¯å¤±è´¥:",n,d)}s===0?console.warn("ðŸŒ æ²¡æœ‰å¯ç”¨çš„è¿žæŽ¥å‘é€æ¶ˆæ¯"):console.log(`ðŸŒ æ¶ˆæ¯å·²å‘é€åˆ° ${s} ä¸ªpeer`)}onMessage(e){this.messageHandlers.push(e)}offMessage(e){const o=this.messageHandlers.indexOf(e);o>-1&&this.messageHandlers.splice(o,1)}getConnectedPeers(){const e=[];for(const[o,s]of this.connections.entries())s.open&&e.push(o);return e}disconnect(){console.log("ðŸŒ æ–­å¼€æ‰€æœ‰PeerJSè¿žæŽ¥");for(const[e,o]of this.connections.entries())o.open&&o.close();this.connections.clear(),this.peer&&!this.peer.destroyed&&this.peer.destroy(),this.messageHandlers=[],this.isInitialized=!1,console.log("ðŸŒ PeerJSè¿žæŽ¥å·²æ–­å¼€")}}class D{peerConnection;roomCode="";peerId="";isHost=!1;hostPeerId="";constructor(){this.peerConnection=new N}async createRoom(e,o){this.roomCode=e,this.peerId=o,this.isHost=!0,this.hostPeerId=o,console.log("ðŸŒ åˆ›å»ºPeerJSæˆ¿é—´:",e),await this.peerConnection.initialize(e,o,!0),console.log("ðŸŒ æˆ¿é—´åˆ›å»ºæˆåŠŸï¼Œç­‰å¾…å…¶ä»–çŽ©å®¶åŠ å…¥")}async joinRoom(e,o,s){this.roomCode=e,this.peerId=o,this.isHost=!1,this.hostPeerId=s,console.log("ðŸŒ åŠ å…¥PeerJSæˆ¿é—´:",e,"æˆ¿ä¸»:",s),await this.peerConnection.initialize(e,o,!1),await this.peerConnection.connectToPeer(s),console.log("ðŸŒ æˆåŠŸåŠ å…¥æˆ¿é—´")}async sendMessage(e){await this.peerConnection.sendMessage(e)}onMessage(e){this.peerConnection.onMessage(e)}offMessage(e){this.peerConnection.offMessage(e)}getConnectedPeers(){return this.peerConnection.getConnectedPeers()}disconnect(){this.peerConnection.disconnect()}}const P=()=>new D,j=x("peerNetwork",()=>{const l=u("disconnected"),e=u(!1),o=u(""),s=u(""),n=u(null),t=u([]),d=u(0),i=u({latency:0,packetLoss:0,bandwidth:0,quality:"excellent",connectionType:"unknown"}),m=p(()=>l.value==="connecting"||l.value==="reconnecting"),w=p(()=>l.value==="connected"),S=p(()=>n.value?n.value.getConnectedPeers():[]),J=p(()=>i.value.latency),C=p(()=>i.value.quality),M=p(()=>i.value.connectionType),I=async(r,c)=>{l.value="connecting",o.value=r,e.value=c;try{console.log(`ðŸŒ åˆå§‹åŒ–PeerJSè¿žæŽ¥ - ${c?"æˆ¿ä¸»":"å®¢æˆ·ç«¯"}`),n.value=P(),n.value.onMessage((a,f)=>{console.log(`ðŸŒ æ”¶åˆ°æ¥è‡ª ${f} çš„æ¶ˆæ¯:`,a.type),t.value.forEach(v=>v(a))}),c&&await n.value.createRoom(r,s.value),l.value="connected",g(),console.log(`ðŸŒ PeerJSè¿žæŽ¥åˆå§‹åŒ–å®Œæˆ - ${c?"æˆ¿ä¸»":"å®¢æˆ·ç«¯"}`)}catch(a){throw l.value="disconnected",console.error("ðŸŒ PeerJSè¿žæŽ¥åˆå§‹åŒ–å¤±è´¥:",a),a}},H=async(r,c)=>{l.value="connecting",o.value=r,e.value=!1;try{console.log(`ðŸŒ è¿žæŽ¥åˆ°PeerJSæˆ¿ä¸»: ${r}, æˆ¿ä¸»ID: ${c}`),n.value=P(),n.value.onMessage((a,f)=>{console.log(`ðŸŒ æ”¶åˆ°æ¥è‡ª ${f} çš„æ¶ˆæ¯:`,a.type),t.value.forEach(v=>v(a))}),await n.value.joinRoom(r,s.value,c),l.value="connected",g(),console.log(`ðŸŒ å·²è¿žæŽ¥åˆ°PeerJSæˆ¿é—´: ${r}`)}catch(a){throw l.value="disconnected",console.error("ðŸŒ è¿žæŽ¥PeerJSæˆ¿é—´å¤±è´¥:",a),a}},z=async r=>{if(!n.value)throw console.error("ðŸŒ PeerJSæˆ¿é—´æœªåˆå§‹åŒ–"),new Error("PeerJS room not initialized");try{const c={...r,timestamp:Date.now(),sequenceId:++d.value,senderId:s.value};await n.value.sendMessage(c),console.log("ðŸŒ PeerJSæ¶ˆæ¯å‘é€æˆåŠŸ:",r.type)}catch(c){throw console.error("ðŸŒ PeerJSå‘é€æ¶ˆæ¯å¤±è´¥:",c),c}},E=r=>{t.value.push(r)},T=r=>{const c=t.value.indexOf(r);c>-1&&t.value.splice(c,1)},k=async()=>{console.log("ðŸŒ æ–­å¼€æ‰€æœ‰PeerJSè¿žæŽ¥"),n.value&&(n.value.disconnect(),n.value=null),l.value="disconnected",t.value=[],y(),console.log("ðŸŒ PeerJSç½‘ç»œè¿žæŽ¥å·²æ–­å¼€")},g=()=>{console.log("ðŸŒ å¼€å§‹PeerJSç½‘ç»œè´¨é‡ç›‘æŽ§"),i.value.connectionType="internet",i.value.quality="good",i.value.latency=30},y=()=>{console.log("ðŸŒ åœæ­¢PeerJSç½‘ç»œè´¨é‡ç›‘æŽ§")},R=()=>{console.log("ðŸŒ å¼€å§‹PeerJSç½‘ç»œç›‘æŽ§"),g()},$=()=>{console.log("ðŸŒ åœæ­¢PeerJSç½‘ç»œç›‘æŽ§"),y()},_=r=>{s.value=r};return{status:h(l),isHost:h(e),roomCode:h(o),playerId:h(s),stats:h(i),isConnecting:m,isConnected:w,connectedPeers:S,latency:J,quality:C,connectionType:M,initializeP2PConnection:I,connectToHost:H,sendMessage:z,onMessage:E,offMessage:T,disconnect:k,startMonitoring:R,stopMonitoring:$,setPlayerId:_}});export{j as usePeerNetworkStore};
