import{a6 as I,r as l,k as g,a7 as p}from"#entry";import"./BoMY4_lC.js";class x{ws=null;roomCode="";peerId="";messageHandlers=[];connectionState="disconnected";reconnectAttempts=0;maxReconnectAttempts=3;constructor(){}async connect(e,n){return this.roomCode=e,this.peerId=n,this.connectionState="connecting",new Promise((o,t)=>{try{const c="wss://echo.websocket.org";console.log("ğŸŒ è¿æ¥åˆ°WebRTCä¿¡ä»¤æœåŠ¡å™¨:",c),this.ws=new WebSocket(c),this.ws.onopen=()=>{console.log("ğŸŒ WebRTCä¿¡ä»¤æœåŠ¡å™¨è¿æ¥æˆåŠŸ"),this.connectionState="connected",this.reconnectAttempts=0,this.sendSignalingMessage({type:"room-register",roomCode:this.roomCode,from:this.peerId,data:{action:"register"},timestamp:Date.now()}),o()},this.ws.onmessage=h=>{try{const i=JSON.parse(h.data);i.roomCode===this.roomCode&&i.from!==this.peerId&&(console.log("ğŸŒ æ”¶åˆ°WebRTCä¿¡ä»¤:",i.type,"from:",i.from),this.messageHandlers.forEach(u=>u(i)))}catch{}},this.ws.onclose=()=>{console.log("ğŸŒ WebRTCä¿¡ä»¤æœåŠ¡å™¨è¿æ¥å…³é—­"),this.connectionState="disconnected",this.attemptReconnect()},this.ws.onerror=h=>{console.error("ğŸŒ WebRTCä¿¡ä»¤æœåŠ¡å™¨é”™è¯¯:",h),this.connectionState="disconnected",t(h)}}catch(c){this.connectionState="disconnected",t(c)}})}attemptReconnect(){if(this.reconnectAttempts<this.maxReconnectAttempts){this.reconnectAttempts++;const e=Math.pow(2,this.reconnectAttempts)*1e3;console.log(`ğŸŒ ${e/1e3}ç§’åå°è¯•é‡è¿ WebRTCä¿¡ä»¤ (${this.reconnectAttempts}/${this.maxReconnectAttempts})`),setTimeout(()=>{this.connect(this.roomCode,this.peerId).catch(console.error)},e)}}async sendSignalingMessage(e){if(this.ws&&this.ws.readyState===WebSocket.OPEN){const n={...e,timestamp:Date.now()};this.ws.send(JSON.stringify(n)),console.log("ğŸŒ å‘é€WebRTCä¿¡ä»¤:",e.type,"to:",e.to||"broadcast")}else throw console.error("ğŸŒ WebRTCä¿¡ä»¤æœåŠ¡å™¨æœªè¿æ¥"),new Error("WebRTC signaling server not connected")}onMessage(e){this.messageHandlers.push(e)}offMessage(e){const n=this.messageHandlers.indexOf(e);n>-1&&this.messageHandlers.splice(n,1)}disconnect(){this.ws&&(this.ws.close(),this.ws=null),this.connectionState="disconnected",this.messageHandlers=[],console.log("ğŸŒ å·²æ–­å¼€WebRTCä¿¡ä»¤æœåŠ¡å™¨è¿æ¥")}getConnectionState(){return this.connectionState}}class E{signalingService;peerConnections=new Map;dataChannels=new Map;messageHandlers=[];roomCode="";peerId="";isHost=!1;rtcConfig={iceServers:[{urls:"stun:stun.l.google.com:19302"},{urls:"stun:stun1.l.google.com:19302"},{urls:"stun:stun.services.mozilla.com"},{urls:"turn:openrelay.metered.ca:80",username:"openrelayproject",credential:"openrelayproject"}],iceCandidatePoolSize:10};constructor(){this.signalingService=new x}async initialize(e,n,o){this.roomCode=e,this.peerId=n,this.isHost=o;try{await this.signalingService.connect(e,n),this.signalingService.onMessage(async t=>{await this.handleSignalingMessage(t)}),console.log("ğŸŒ WebRTCè¿æ¥ç®¡ç†å™¨åˆå§‹åŒ–æˆåŠŸ")}catch(t){throw console.error("ğŸŒ WebRTCè¿æ¥ç®¡ç†å™¨åˆå§‹åŒ–å¤±è´¥:",t),t}}async handleSignalingMessage(e){const{type:n,from:o,data:t}=e;switch(n){case"room-join":this.isHost&&await this.createOffer(o);break;case"offer":await this.handleOffer(o,t);break;case"answer":await this.handleAnswer(o,t);break;case"ice-candidate":await this.handleIceCandidate(o,t);break;case"player-data":this.messageHandlers.forEach(c=>c(t,o));break}}async createPeerConnection(e){const n=new RTCPeerConnection(this.rtcConfig);return n.onicecandidate=o=>{o.candidate&&this.signalingService.sendSignalingMessage({type:"ice-candidate",roomCode:this.roomCode,from:this.peerId,to:e,data:o.candidate,timestamp:Date.now()})},n.onconnectionstatechange=()=>{console.log(`ğŸŒ ä¸ ${e} çš„è¿æ¥çŠ¶æ€:`,n.connectionState)},n.ondatachannel=o=>{const t=o.channel;this.setupDataChannel(t,e)},this.peerConnections.set(e,n),n}setupDataChannel(e,n){e.onopen=()=>{console.log(`ğŸŒ æ•°æ®é€šé“å·²æ‰“å¼€: ${n}`)},e.onmessage=o=>{try{const t=JSON.parse(o.data);this.messageHandlers.forEach(c=>c(t,n))}catch(t){console.error("ğŸŒ è§£ææ•°æ®é€šé“æ¶ˆæ¯å¤±è´¥:",t)}},e.onclose=()=>{console.log(`ğŸŒ æ•°æ®é€šé“å·²å…³é—­: ${n}`)},this.dataChannels.set(n,e)}async createOffer(e){try{const n=await this.createPeerConnection(e),o=n.createDataChannel("gameData",{ordered:!0});this.setupDataChannel(o,e);const t=await n.createOffer();await n.setLocalDescription(t),await this.signalingService.sendSignalingMessage({type:"offer",roomCode:this.roomCode,from:this.peerId,to:e,data:t,timestamp:Date.now()}),console.log(`ğŸŒ å·²å‘ ${e} å‘é€offer`)}catch(n){console.error("ğŸŒ åˆ›å»ºofferå¤±è´¥:",n)}}async handleOffer(e,n){try{const o=await this.createPeerConnection(e);await o.setRemoteDescription(n);const t=await o.createAnswer();await o.setLocalDescription(t),await this.signalingService.sendSignalingMessage({type:"answer",roomCode:this.roomCode,from:this.peerId,to:e,data:t,timestamp:Date.now()}),console.log(`ğŸŒ å·²å‘ ${e} å‘é€answer`)}catch(o){console.error("ğŸŒ å¤„ç†offerå¤±è´¥:",o)}}async handleAnswer(e,n){try{const o=this.peerConnections.get(e);o&&(await o.setRemoteDescription(n),console.log(`ğŸŒ å·²è®¾ç½®æ¥è‡ª ${e} çš„answer`))}catch(o){console.error("ğŸŒ å¤„ç†answerå¤±è´¥:",o)}}async handleIceCandidate(e,n){try{const o=this.peerConnections.get(e);o&&(await o.addIceCandidate(n),console.log(`ğŸŒ å·²æ·»åŠ æ¥è‡ª ${e} çš„ICEå€™é€‰`))}catch(o){console.error("ğŸŒ å¤„ç†ICEå€™é€‰å¤±è´¥:",o)}}async joinRoom(){this.isHost||(await this.signalingService.sendSignalingMessage({type:"room-join",roomCode:this.roomCode,from:this.peerId,data:{action:"join"},timestamp:Date.now()}),console.log("ğŸŒ å·²å‘é€æˆ¿é—´åŠ å…¥è¯·æ±‚"))}async sendMessage(e){const n=JSON.stringify(e);for(const[o,t]of this.dataChannels.entries())t.readyState==="open"&&(t.send(n),console.log(`ğŸŒ é€šè¿‡æ•°æ®é€šé“å‘é€æ¶ˆæ¯åˆ° ${o}`));this.dataChannels.size===0&&(await this.signalingService.sendSignalingMessage({type:"player-data",roomCode:this.roomCode,from:this.peerId,data:e,timestamp:Date.now()}),console.log("ğŸŒ é€šè¿‡ä¿¡ä»¤æœåŠ¡å™¨å‘é€æ¶ˆæ¯"))}onMessage(e){this.messageHandlers.push(e)}offMessage(e){const n=this.messageHandlers.indexOf(e);n>-1&&this.messageHandlers.splice(n,1)}disconnect(){for(const[e,n]of this.peerConnections.entries())n.close();this.peerConnections.clear();for(const[e,n]of this.dataChannels.entries())n.close();this.dataChannels.clear(),this.signalingService.disconnect(),this.messageHandlers=[],console.log("ğŸŒ WebRTCè¿æ¥ç®¡ç†å™¨å·²æ–­å¼€æ‰€æœ‰è¿æ¥")}getConnectedPeers(){const e=[];for(const[n,o]of this.peerConnections.entries())o.connectionState==="connected"&&e.push(n);return e}}const f=()=>new E,j=I("realNetwork",()=>{const r=l("disconnected"),e=l(!1),n=l(""),o=l(""),t=l(null),c=l([]),h=l(0),i=l({latency:0,packetLoss:0,bandwidth:0,quality:"excellent",connectionType:"unknown"}),u=g(()=>r.value==="connecting"||r.value==="reconnecting"),y=g(()=>r.value==="connected"),v=g(()=>t.value?t.value.getConnectedPeers():[]),S=g(()=>i.value.latency),M=g(()=>i.value.quality),b=g(()=>i.value.connectionType),R=async(a,s)=>{r.value="connecting",n.value=a,e.value=s;try{console.log(`ğŸŒ åˆå§‹åŒ–P2Pè¿æ¥ - ${s?"æˆ¿ä¸»":"å®¢æˆ·ç«¯"}`),t.value=f(),await t.value.initialize(a,o.value,s),t.value.onMessage((d,C)=>{console.log(`ğŸŒ æ”¶åˆ°æ¥è‡ª ${C} çš„æ¶ˆæ¯:`,d.type),c.value.forEach(A=>A(d))}),r.value="connected",m(),console.log(`ğŸŒ P2Pè¿æ¥åˆå§‹åŒ–å®Œæˆ - ${s?"æˆ¿ä¸»":"å®¢æˆ·ç«¯"}`)}catch(d){throw r.value="disconnected",console.error("ğŸŒ P2Pè¿æ¥åˆå§‹åŒ–å¤±è´¥:",d),d}},T=async a=>{r.value="connecting",n.value=a,e.value=!1;try{console.log(`ğŸŒ è¿æ¥åˆ°æˆ¿ä¸»: ${a}`),t.value=f(),await t.value.initialize(a,o.value,!1),t.value.onMessage((s,d)=>{console.log(`ğŸŒ æ”¶åˆ°æ¥è‡ª ${d} çš„æ¶ˆæ¯:`,s.type),c.value.forEach(C=>C(s))}),await t.value.joinRoom(),r.value="connected",m(),console.log(`ğŸŒ å·²è¿æ¥åˆ°æˆ¿é—´: ${a}`)}catch(s){throw r.value="disconnected",console.error("ğŸŒ è¿æ¥æˆ¿é—´å¤±è´¥:",s),s}},W=async a=>{if(!t.value)throw console.error("ğŸŒ WebRTCç®¡ç†å™¨æœªåˆå§‹åŒ–"),new Error("WebRTC manager not initialized");try{const s={...a,timestamp:Date.now(),sequenceId:++h.value,senderId:o.value};await t.value.sendMessage(s),console.log("ğŸŒ æ¶ˆæ¯å‘é€æˆåŠŸ:",a.type)}catch(s){throw console.error("ğŸŒ å‘é€æ¶ˆæ¯å¤±è´¥:",s),s}},H=a=>{c.value.push(a)},D=a=>{const s=c.value.indexOf(a);s>-1&&c.value.splice(s,1)},$=async()=>{console.log("ğŸŒ æ–­å¼€æ‰€æœ‰ç½‘ç»œè¿æ¥"),t.value&&(t.value.disconnect(),t.value=null),r.value="disconnected",c.value=[],w(),console.log("ğŸŒ ç½‘ç»œè¿æ¥å·²æ–­å¼€")},m=()=>{console.log("ğŸŒ å¼€å§‹ç½‘ç»œè´¨é‡ç›‘æ§"),i.value.connectionType="internet",i.value.quality="good",i.value.latency=50},w=()=>{console.log("ğŸŒ åœæ­¢ç½‘ç»œè´¨é‡ç›‘æ§")},k=()=>{console.log("ğŸŒ å¼€å§‹ç½‘ç»œç›‘æ§"),m()},O=()=>{console.log("ğŸŒ åœæ­¢ç½‘ç»œç›‘æ§"),w()},P=a=>{o.value=a};return{status:p(r),isHost:p(e),roomCode:p(n),playerId:p(o),stats:p(i),isConnecting:u,isConnected:y,connectedPeers:v,latency:S,quality:M,connectionType:b,initializeP2PConnection:R,connectToHost:T,sendMessage:W,onMessage:H,offMessage:D,disconnect:$,startMonitoring:k,stopMonitoring:O,setPlayerId:P}});export{j as useRealNetworkStore};
