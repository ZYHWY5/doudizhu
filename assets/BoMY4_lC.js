class a{static instance;roomRegistry=new Map;messageHandlers=[];broadcastChannel=null;constructor(){typeof window<"u"&&"BroadcastChannel"in window&&(this.broadcastChannel=new BroadcastChannel("doudizhu-signaling"),this.broadcastChannel.onmessage=o=>{const e=o.data;this.messageHandlers.forEach(t=>t(e))})}static getInstance(){return a.instance||(a.instance=new a),a.instance}registerRoom(o){this.roomRegistry.set(o.roomCode,o),console.log("ğŸ“¡ æˆ¿é—´å·²æ³¨å†Œ:",o),this.broadcast({type:"room-info",roomCode:o.roomCode,from:o.hostPeerId,data:o,timestamp:Date.now()})}getRoomInfo(o){const e=this.roomRegistry.get(o);return e?(console.log("ğŸ“¡ æ‰¾åˆ°æˆ¿é—´ä¿¡æ¯:",e),e):(console.log(`ğŸ“¡ æˆ¿é—´ä¸å­˜åœ¨: ${o}`),null)}generateRoomLink(o){let e="https://zyhwy5.github.io/doudizhu/";if(typeof window<"u"){const n=window.location.host;!n.includes("localhost")&&!n.includes("127.0.0.1")&&(e=`${window.location.protocol}//${window.location.host}${window.location.pathname}`)}const t=new URLSearchParams({join:o.roomCode,host:o.hostPeerId,name:o.hostName,t:o.timestamp.toString()}),s=`${e}#/room/${o.roomCode}?${t.toString()}`;return console.log("ğŸ“¡ ç”Ÿæˆæˆ¿é—´é“¾æ¥:",s),s}generateQRData(o){return this.generateRoomLink(o)}parseRoomFromUrl(){if(typeof window>"u")return null;try{const o=window.location.hash;console.log("ğŸ“¡ å½“å‰URL hash:",o);const e=o.match(/\/room\/([A-Z0-9]{6})/);if(!e)return console.log("ğŸ“¡ æœªåŒ¹é…åˆ°æˆ¿é—´ç è·¯å¾„"),null;const t=e[1];console.log("ğŸ“¡ è§£æåˆ°æˆ¿é—´ç :",t);const s=o.match(/\?(.+)$/);if(!s)return console.log("ğŸ“¡ æœªæ‰¾åˆ°æŸ¥è¯¢å‚æ•°"),null;const n=new URLSearchParams(s[1]),r=n.get("host"),i=n.get("name"),c=n.get("t");if(console.log("ğŸ“¡ è§£æåˆ°å‚æ•°:",{hostPeerId:r,hostName:i,timestamp:c}),r&&i&&c){const l={roomCode:t,hostPeerId:r,hostName:i,timestamp:parseInt(c)};return console.log("ğŸ“¡ ä»URLè§£ææˆ¿é—´ä¿¡æ¯:",l),{roomCode:t,hostInfo:l}}else console.log("ğŸ“¡ å‚æ•°ä¸å®Œæ•´ï¼Œæ— æ³•è§£ææˆ¿é—´ä¿¡æ¯")}catch(o){console.error("ğŸ“¡ è§£æURLæˆ¿é—´ä¿¡æ¯å¤±è´¥:",o)}return null}broadcast(o){this.broadcastChannel&&(this.broadcastChannel.postMessage(o),console.log("ğŸ“¡ å¹¿æ’­æ¶ˆæ¯:",o.type))}onMessage(o){this.messageHandlers.push(o)}offMessage(o){const e=this.messageHandlers.indexOf(o);e>-1&&this.messageHandlers.splice(e,1)}cleanupExpiredRooms(){const o=Date.now(),e=3600*1e3;for(const[t,s]of this.roomRegistry.entries())o-s.timestamp>e&&(this.roomRegistry.delete(t),console.log(`ğŸ“¡ æ¸…ç†è¿‡æœŸæˆ¿é—´: ${t}`))}cleanup(){this.broadcastChannel&&(this.broadcastChannel.close(),this.broadcastChannel=null),this.messageHandlers=[],this.roomRegistry.clear(),console.log("ğŸ“¡ æ¸…ç†ä¿¡ä»¤æœåŠ¡èµ„æº")}}const h=a.getInstance(),m=d=>h.generateRoomLink(d),g=()=>h.parseRoomFromUrl();export{a as SimpleSignalingService,m as generateRoomLink,g as parseRoomFromUrl,h as signalingService};
