class a{static instance;roomRegistry=new Map;messageHandlers=[];broadcastChannel=null;constructor(){typeof window<"u"&&"BroadcastChannel"in window&&(this.broadcastChannel=new BroadcastChannel("doudizhu-signaling"),this.broadcastChannel.onmessage=o=>{const e=o.data;this.messageHandlers.forEach(t=>t(e))})}static getInstance(){return a.instance||(a.instance=new a),a.instance}registerRoom(o){this.roomRegistry.set(o.roomCode,o),console.log("📡 房间已注册:",o),this.broadcast({type:"room-info",roomCode:o.roomCode,from:o.hostPeerId,data:o,timestamp:Date.now()})}getRoomInfo(o){const e=this.roomRegistry.get(o);return e?(console.log("📡 找到房间信息:",e),e):(console.log(`📡 房间不存在: ${o}`),null)}generateRoomLink(o){let e="https://zyhwy5.github.io/doudizhu/";if(typeof window<"u"){const n=window.location.host;!n.includes("localhost")&&!n.includes("127.0.0.1")&&(e=`${window.location.protocol}//${window.location.host}${window.location.pathname}`)}const t=new URLSearchParams({join:o.roomCode,host:o.hostPeerId,name:o.hostName,t:o.timestamp.toString()}),s=`${e}#/room/${o.roomCode}?${t.toString()}`;return console.log("📡 生成房间链接:",s),s}generateQRData(o){return this.generateRoomLink(o)}parseRoomFromUrl(){if(typeof window>"u")return null;try{const o=window.location.hash;console.log("📡 当前URL hash:",o);const e=o.match(/\/room\/([A-Z0-9]{6})/);if(!e)return console.log("📡 未匹配到房间码路径"),null;const t=e[1];console.log("📡 解析到房间码:",t);const s=o.match(/\?(.+)$/);if(!s)return console.log("📡 未找到查询参数"),null;const n=new URLSearchParams(s[1]),r=n.get("host"),i=n.get("name"),c=n.get("t");if(console.log("📡 解析到参数:",{hostPeerId:r,hostName:i,timestamp:c}),r&&i&&c){const l={roomCode:t,hostPeerId:r,hostName:i,timestamp:parseInt(c)};return console.log("📡 从URL解析房间信息:",l),{roomCode:t,hostInfo:l}}else console.log("📡 参数不完整，无法解析房间信息")}catch(o){console.error("📡 解析URL房间信息失败:",o)}return null}broadcast(o){this.broadcastChannel&&(this.broadcastChannel.postMessage(o),console.log("📡 广播消息:",o.type))}onMessage(o){this.messageHandlers.push(o)}offMessage(o){const e=this.messageHandlers.indexOf(o);e>-1&&this.messageHandlers.splice(e,1)}cleanupExpiredRooms(){const o=Date.now(),e=3600*1e3;for(const[t,s]of this.roomRegistry.entries())o-s.timestamp>e&&(this.roomRegistry.delete(t),console.log(`📡 清理过期房间: ${t}`))}cleanup(){this.broadcastChannel&&(this.broadcastChannel.close(),this.broadcastChannel=null),this.messageHandlers=[],this.roomRegistry.clear(),console.log("📡 清理信令服务资源")}}const h=a.getInstance(),m=d=>h.generateRoomLink(d),g=()=>h.parseRoomFromUrl();export{a as SimpleSignalingService,m as generateRoomLink,g as parseRoomFromUrl,h as signalingService};
